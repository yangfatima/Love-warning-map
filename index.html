<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ’” å…¨çƒæ‹çˆ±é¿é›·åœ°å›¾</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/globe.gl@2.27.2/dist/globe.gl.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Orbitron:wght@400;700;900&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#000510;--glass:rgba(255,255,255,0.04);--glass-border:rgba(0,150,255,0.2);--blue:#0096ff;--red:#ff3d3d;--orange:#ff7c1f;--yellow:#ffd23f}
html,body{width:100%;height:100%;background:var(--bg);overflow:hidden;font-family:'Noto Sans SC',sans-serif;color:#fff}
#globe-container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
/* DASHBOARD */
#dashboard{position:fixed;top:20px;left:20px;background:var(--glass);backdrop-filter:blur(20px) saturate(160%);-webkit-backdrop-filter:blur(20px) saturate(160%);border:1px solid var(--glass-border);border-radius:16px;padding:18px 24px;min-width:220px;box-shadow:0 8px 32px rgba(0,150,255,0.1),inset 0 1px 0 rgba(255,255,255,0.06);z-index:10}
#dashboard .label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--blue);opacity:.7;margin-bottom:4px}
#dashboard .value{font-family:'Orbitron',monospace;font-size:28px;font-weight:700;background:linear-gradient(135deg,#fff 40%,var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1.1}
#dashboard .sub-value{font-family:'Orbitron',monospace;font-size:18px;font-weight:400;color:var(--orange);margin-top:6px}
#dashboard .divider{height:1px;background:var(--glass-border);margin:12px 0}
#dashboard .today-label{font-size:10px;letter-spacing:2px;color:var(--orange);opacity:.7;margin-bottom:2px}
/* LEGEND */
#legend{position:fixed;top:20px;right:20px;background:var(--glass);backdrop-filter:blur(20px) saturate(160%);-webkit-backdrop-filter:blur(20px) saturate(160%);border:1px solid var(--glass-border);border-radius:16px;padding:16px 20px;box-shadow:0 8px 32px rgba(0,150,255,0.1),inset 0 1px 0 rgba(255,255,255,0.06);z-index:10}
#legend h3{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--blue);margin-bottom:12px}
.legend-item{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-size:12px;color:rgba(255,255,255,.8)}
.legend-item:last-child{margin-bottom:0}
.legend-dot-wrap{position:relative;width:18px;height:18px;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.legend-dot{width:8px;height:8px;border-radius:50%;position:relative;z-index:1}
.legend-ring{position:absolute;inset:0;border-radius:50%;border:2px solid transparent}
.dot-red .legend-dot{background:#ff3d3d;box-shadow:0 0 10px 3px #ff3d3d;animation:blink-high .55s steps(1,end) infinite}
.dot-red .legend-ring{border-color:#ff3d3d;animation:ring-high .55s ease-out infinite}
@keyframes blink-high{0%{opacity:1;transform:scale(1.25);box-shadow:0 0 14px 5px #ff3d3d}50%{opacity:.08;transform:scale(.7);box-shadow:none}100%{opacity:1;transform:scale(1.25);box-shadow:0 0 14px 5px #ff3d3d}}
@keyframes ring-high{0%{transform:scale(1);opacity:.9}70%{transform:scale(2.2);opacity:0}100%{transform:scale(1);opacity:0}}
.dot-orange .legend-dot{background:#ff7c1f;box-shadow:0 0 8px 2px #ff7c1f;animation:blink-med 1.2s ease-in-out infinite}
.dot-orange .legend-ring{border-color:#ff7c1f;animation:ring-med 1.2s ease-out infinite}
@keyframes blink-med{0%,100%{opacity:1;transform:scale(1.1);box-shadow:0 0 10px 3px #ff7c1f}50%{opacity:.25;transform:scale(.8);box-shadow:0 0 2px 1px #ff7c1f}}
@keyframes ring-med{0%{transform:scale(1);opacity:.7}80%{transform:scale(2);opacity:0}100%{transform:scale(1);opacity:0}}
.dot-yellow .legend-dot{background:#ffd23f;box-shadow:0 0 6px 1px #ffd23f;animation:blink-low 2.4s ease-in-out infinite}
.dot-yellow .legend-ring{border-color:#ffd23f;animation:ring-low 2.4s ease-out infinite}
@keyframes blink-low{0%,100%{opacity:1;transform:scale(1);box-shadow:0 0 7px 2px #ffd23f}50%{opacity:.5;transform:scale(.88);box-shadow:0 0 2px 0px #ffd23f}}
@keyframes ring-low{0%{transform:scale(1);opacity:.5}90%{transform:scale(1.7);opacity:0}100%{transform:scale(1);opacity:0}}
.dot-white .legend-dot{background:rgba(200,215,255,.35);box-shadow:0 0 4px 1px rgba(180,200,255,.3)}
.dot-white .legend-ring{border-color:rgba(200,215,255,.15);transform:scale(1.5);opacity:.4}
/* LANG SWITCHER */
#lang-switcher{position:fixed;bottom:30px;left:24px;display:flex;align-items:center;background:var(--glass);backdrop-filter:blur(20px) saturate(160%);-webkit-backdrop-filter:blur(20px) saturate(160%);border:1px solid var(--glass-border);border-radius:50px;padding:4px;z-index:10;box-shadow:0 4px 20px rgba(0,150,255,.12)}
.lang-btn{padding:8px 16px;border:none;border-radius:50px;font-size:12px;font-weight:600;letter-spacing:1px;cursor:pointer;transition:all .25s;background:transparent;color:rgba(255,255,255,.4);font-family:'Orbitron',monospace}
.lang-btn.active{background:linear-gradient(135deg,#0096ff,#0055cc);color:#fff;box-shadow:0 2px 12px rgba(0,150,255,.4)}
.lang-btn:hover:not(.active){color:rgba(255,255,255,.8)}
/* FAB */
#fab{position:fixed;bottom:30px;right:24px;background:linear-gradient(135deg,#ff4e6a,#ff7c1f);border:none;border-radius:50px;padding:14px 22px;color:#fff;font-size:13px;font-weight:500;font-family:'Noto Sans SC',sans-serif;cursor:pointer;z-index:10;box-shadow:0 4px 24px rgba(255,78,106,.5);transition:transform .2s,box-shadow .2s;white-space:nowrap;letter-spacing:.5px}
#fab:hover{transform:translateY(-3px) scale(1.03);box-shadow:0 8px 32px rgba(255,78,106,.7)}
#fab:active{transform:scale(.97)}
/* MODAL */
#modal-overlay{position:fixed;inset:0;background:rgba(0,5,16,.75);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:100;display:none;align-items:center;justify-content:center;padding:16px}
#modal-overlay.open{display:flex}
#modal{background:#fff;border-radius:20px;padding:32px;width:100%;max-width:440px;color:#111;box-shadow:0 24px 80px rgba(0,0,0,.6);animation:modal-in .3s cubic-bezier(.34,1.56,.64,1);max-height:90vh;overflow-y:auto}
@keyframes modal-in{from{opacity:0;transform:scale(.85) translateY(20px)}to{opacity:1;transform:none}}
#modal h2{font-size:20px;font-weight:700;margin-bottom:6px}
#modal .modal-sub{font-size:13px;color:#666;margin-bottom:24px}
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:12px;font-weight:500;color:#444;margin-bottom:8px;letter-spacing:.5px}
.radio-group{display:flex;gap:10px;flex-wrap:wrap}
.radio-btn{flex:1;min-width:80px;background:#f4f4f6;border:2px solid transparent;border-radius:10px;padding:10px;text-align:center;font-size:13px;cursor:pointer;transition:all .15s;user-select:none}
.radio-btn:hover{border-color:#ddd}
.radio-btn.selected{background:#fff0f3;border-color:#ff4e6a;color:#ff4e6a;font-weight:600}
.chip-group{display:flex;gap:8px;flex-wrap:wrap}
.chip{background:#f4f4f6;border:2px solid transparent;border-radius:20px;padding:7px 14px;font-size:12px;cursor:pointer;transition:all .15s;user-select:none;white-space:nowrap}
.chip:hover{border-color:#ddd}
.chip.selected{background:#fff3e8;border-color:var(--orange);color:var(--orange);font-weight:600}
select,input[type="text"]{width:100%;padding:11px 14px;border:2px solid #eee;border-radius:10px;font-size:14px;font-family:inherit;outline:none;transition:border-color .15s;background:#fafafa;color:#111}
select:focus,input[type="text"]:focus{border-color:#0096ff;background:#fff}
.modal-footer{display:flex;gap:12px;margin-top:24px}
.btn-cancel{flex:1;padding:13px;border:2px solid #eee;background:transparent;border-radius:10px;font-size:14px;cursor:pointer;font-family:inherit;transition:all .15s}
.btn-cancel:hover{border-color:#ccc}
.btn-submit{flex:2;padding:13px;background:linear-gradient(135deg,#ff4e6a,#ff7c1f);border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s}
.btn-submit:hover{opacity:.9;transform:translateY(-1px)}
/* TOAST */
#toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);background:rgba(30,30,40,.95);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px 24px;font-size:13px;color:#fff;z-index:200;opacity:0;transition:all .4s;pointer-events:none;white-space:nowrap}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
#ripple-canvas{position:fixed;inset:0;pointer-events:none;z-index:5}
@media(max-width:480px){
  #dashboard{top:10px;left:10px;padding:12px 16px;min-width:160px}
  #dashboard .value{font-size:20px}
  #legend{top:10px;right:10px;padding:12px 14px}
  #fab{bottom:20px;right:12px;font-size:12px;padding:12px 16px}
  #lang-switcher{bottom:20px;left:12px}
  #modal{padding:24px 20px}
}
</style>
</head>
<body>

<div id="globe-container"></div>
<canvas id="ripple-canvas"></canvas>

<!-- Dashboard -->
<div id="dashboard">
  <div class="label" id="d-label">ğŸ’” å…¨çƒé¿é›·æŠ•ç¥¨æ€»æ•°</div>
  <div class="value" id="total-count">0</div>
  <div class="divider"></div>
  <div class="today-label" id="d-today-label">ğŸ”¥ ä»Šæ—¥æ–°å¢é¿é›·</div>
  <div class="sub-value" id="today-count">+0</div>
</div>

<!-- Legend -->
<div id="legend">
  <h3 id="legend-title">âš¡ é£é™©é¢„è­¦æ ‡å‡†</h3>
  <div class="legend-item">
    <div class="legend-dot-wrap dot-red"><div class="legend-ring"></div><div class="legend-dot"></div></div>
    <span id="leg-high">é«˜å±åŒºåŸŸ</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot-wrap dot-orange"><div class="legend-ring"></div><div class="legend-dot"></div></div>
    <span id="leg-med">ä¸­åº¦é¢„è­¦</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot-wrap dot-yellow"><div class="legend-ring"></div><div class="legend-dot"></div></div>
    <span id="leg-low">è½»åº¦é£é™©</span>
  </div>
  <div class="legend-item">
    <div class="legend-dot-wrap dot-white"><div class="legend-ring"></div><div class="legend-dot"></div></div>
    <span id="leg-min">æ•°æ®ç¨€å°‘</span>
  </div>
</div>

<!-- Lang Switcher -->
<div id="lang-switcher">
  <button class="lang-btn active" id="btn-zh" onclick="setLang('zh')">ä¸­æ–‡</button>
  <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
</div>

<!-- FAB -->
<button id="fab">âœ¨ åˆ†äº«ä½ çš„æ‹çˆ±é¿é›·åæ ‡</button>

<!-- Modal -->
<div id="modal-overlay">
  <div id="modal">
    <h2 id="modal-title">ğŸ“ æäº¤é¿é›·åæ ‡</h2>
    <p class="modal-sub" id="modal-sub">ä½ çš„ç»å†å°†å¸®åŠ©å…¨çƒæ‹çˆ±äººå£«é¿å¼€é›·åŒº</p>

    <div class="form-group">
      <label id="label-gender">ä½ çš„æ€§åˆ«</label>
      <div class="radio-group">
        <div class="radio-btn" data-group="gender" data-val="male"   id="btn-male">â™‚ ç”·</div>
        <div class="radio-btn" data-group="gender" data-val="female" id="btn-female">â™€ å¥³</div>
      </div>
    </div>

    <div class="form-group">
      <label id="label-type">è¸©é›·ç±»å‹</label>
      <div class="chip-group">
        <div class="chip" data-group="type" data-val="ghost"     id="chip-ghost">ğŸ‘» å¤±è”</div>
        <div class="chip" data-group="type" data-val="multiline" id="chip-multi">ğŸ­ æš§æ˜§å¤šçº¿</div>
        <div class="chip" data-group="type" data-val="pie"       id="chip-pie">ğŸ¥§ ç”»é¥¼</div>
        <div class="chip" data-group="type" data-val="ignore"    id="chip-ignore">ğŸ“µ å·²è¯»ä¸å›</div>
        <div class="chip" data-group="type" data-val="other"     id="chip-other">ğŸ’« å…¶å®ƒ</div>
      </div>
    </div>

    <div class="form-group">
      <label id="label-country">å‘ç”Ÿåœ°ç‚¹ â€” å›½å®¶</label>
      <select id="country-select"></select>
    </div>

    <div class="form-group">
      <label id="label-city">å‘ç”Ÿåœ°ç‚¹ â€” åŸå¸‚</label>
      <input type="text" id="city-input" placeholder="è¾“å…¥åŸå¸‚åç§°ï¼Œå¦‚ ä¸Šæµ·ã€Tokyo..." list="city-datalist">
      <datalist id="city-datalist"></datalist>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" id="modal-cancel">å–æ¶ˆ</button>
      <button class="btn-submit" id="modal-submit">ğŸš¨ æäº¤é¿é›·ï¼</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  1. I18N â€” MUST BE FIRST (everything below depends on it)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TRANSLATIONS = {
  zh: {
    pageTitle:'ğŸ’” å…¨çƒæ‹çˆ±é¿é›·åœ°å›¾',
    dashLabel:'ğŸ’” å…¨çƒé¿é›·æŠ•ç¥¨æ€»æ•°',
    todayLabel:'ğŸ”¥ ä»Šæ—¥æ–°å¢é¿é›·',
    legendTitle:'âš¡ é£é™©é¢„è­¦æ ‡å‡†',
    legendHigh:'é«˜å±åŒºåŸŸ', legendMed:'ä¸­åº¦é¢„è­¦', legendLow:'è½»åº¦é£é™©', legendMin:'æ•°æ®ç¨€å°‘',
    fab:'âœ¨ åˆ†äº«ä½ çš„æ‹çˆ±é¿é›·åæ ‡',
    modalTitle:'ğŸ“ æäº¤é¿é›·åæ ‡',
    modalSub:'ä½ çš„ç»å†å°†å¸®åŠ©å…¨çƒæ‹çˆ±äººå£«é¿å¼€é›·åŒº',
    genderLabel:'ä½ çš„æ€§åˆ«', genderM:'â™‚ ç”·', genderF:'â™€ å¥³',
    typeLabel:'è¸©é›·ç±»å‹',
    typeGhost:'ğŸ‘» å¤±è”', typeMulti:'ğŸ­ æš§æ˜§å¤šçº¿', typePie:'ğŸ¥§ ç”»é¥¼', typeIgnore:'ğŸ“µ å·²è¯»ä¸å›', typeOther:'ğŸ’« å…¶å®ƒ',
    countryLabel:'å‘ç”Ÿåœ°ç‚¹ â€” å›½å®¶', countryPH:'è¯·é€‰æ‹©å›½å®¶...',
    cityLabel:'å‘ç”Ÿåœ°ç‚¹ â€” åŸå¸‚', cityPH:'è¾“å…¥åŸå¸‚åç§°ï¼Œå¦‚ ä¸Šæµ·ã€Tokyo...',
    cancelBtn:'å–æ¶ˆ', submitBtn:'ğŸš¨ æäº¤é¿é›·ï¼',
    toastSuccess:'ğŸš¨ é¿é›·åæ ‡å·²æ°¸ä¹…æ ‡è®°ï¼ä¿æŠ¤åæ¥è€…',
    toastWarn:'âš ï¸ è¯·å¡«å†™æ‰€æœ‰å­—æ®µå†æäº¤',
    pointToast:(city,country,n)=>`ğŸ“ ${city} Â· ${country} â€” ${n} æ¬¡é¿é›·è®°å½•`,
  },
  en: {
    pageTitle:'ğŸ’” Global Love Minefield Map',
    dashLabel:'ğŸ’” Total Global Reports',
    todayLabel:'ğŸ”¥ New Reports Today',
    legendTitle:'âš¡ RISK LEVELS',
    legendHigh:'High Risk', legendMed:'Moderate Alert', legendLow:'Low Risk', legendMin:'Sparse Data',
    fab:'âœ¨ Share Your Heartbreak Spot',
    modalTitle:'ğŸ“ Submit a Warning',
    modalSub:'Your story helps others avoid the same mistake',
    genderLabel:'Your Gender', genderM:'â™‚ Male', genderF:'â™€ Female',
    typeLabel:'Incident Type',
    typeGhost:'ğŸ‘» Ghosted', typeMulti:'ğŸ­ Two-timing', typePie:'ğŸ¥§ Empty Promises', typeIgnore:'ğŸ“µ Left on Read', typeOther:'ğŸ’« Other',
    countryLabel:'Location â€” Country', countryPH:'Select a country...',
    cityLabel:'Location â€” City', cityPH:'Enter city, e.g. Shanghai, Tokyo...',
    cancelBtn:'Cancel', submitBtn:'ğŸš¨ Submit Warning!',
    toastSuccess:'ğŸš¨ Warning permanently marked! Others are now protected',
    toastWarn:'âš ï¸ Please fill in all fields before submitting',
    pointToast:(city,country,n)=>`ğŸ“ ${city} Â· ${country} â€” ${n} reports`,
  }
};

let currentLang = 'zh';  // single source of truth

function T(key) { return TRANSLATIONS[currentLang][key]; }

function applyLang() {
  const tr = TRANSLATIONS[currentLang];
  document.title = tr.pageTitle;
  document.getElementById('d-label').textContent      = tr.dashLabel;
  document.getElementById('d-today-label').textContent= tr.todayLabel;
  document.getElementById('legend-title').textContent = tr.legendTitle;
  document.getElementById('leg-high').textContent     = tr.legendHigh;
  document.getElementById('leg-med').textContent      = tr.legendMed;
  document.getElementById('leg-low').textContent      = tr.legendLow;
  document.getElementById('leg-min').textContent      = tr.legendMin;
  document.getElementById('fab').textContent          = tr.fab;
  document.getElementById('modal-title').textContent  = tr.modalTitle;
  document.getElementById('modal-sub').textContent    = tr.modalSub;
  document.getElementById('label-gender').textContent = tr.genderLabel;
  document.getElementById('btn-male').textContent     = tr.genderM;
  document.getElementById('btn-female').textContent   = tr.genderF;
  document.getElementById('label-type').textContent   = tr.typeLabel;
  document.getElementById('chip-ghost').textContent   = tr.typeGhost;
  document.getElementById('chip-multi').textContent   = tr.typeMulti;
  document.getElementById('chip-pie').textContent     = tr.typePie;
  document.getElementById('chip-ignore').textContent  = tr.typeIgnore;
  document.getElementById('chip-other').textContent   = tr.typeOther;
  document.getElementById('label-country').textContent= tr.countryLabel;
  document.getElementById('label-city').textContent   = tr.cityLabel;
  document.getElementById('city-input').placeholder   = tr.cityPH;
  document.getElementById('modal-cancel').textContent = tr.cancelBtn;
  document.getElementById('modal-submit').textContent = tr.submitBtn;
  // Country + city dropdowns rebuild in current language
  buildCountrySelect();
}

function setLang(lang) {
  if (lang === currentLang) return;
  currentLang = lang;
  document.getElementById('btn-zh').classList.toggle('active', lang === 'zh');
  document.getElementById('btn-en').classList.toggle('active', lang === 'en');
  applyLang();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  2. DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CITY_DATA = [
  {city:"ä¸Šæµ·",   cityEn:"Shanghai",        lat:31.2304,  lng:121.4737, count:3240, country:"ä¸­å›½",       countryEn:"China"},
  {city:"åŒ—äº¬",   cityEn:"Beijing",          lat:39.9042,  lng:116.4074, count:2980, country:"ä¸­å›½",       countryEn:"China"},
  {city:"å¹¿å·",   cityEn:"Guangzhou",        lat:23.1291,  lng:113.2644, count:2100, country:"ä¸­å›½",       countryEn:"China"},
  {city:"æ·±åœ³",   cityEn:"Shenzhen",         lat:22.5431,  lng:114.0579, count:1870, country:"ä¸­å›½",       countryEn:"China"},
  {city:"æˆéƒ½",   cityEn:"Chengdu",          lat:30.5728,  lng:104.0668, count:1430, country:"ä¸­å›½",       countryEn:"China"},
  {city:"æ­¦æ±‰",   cityEn:"Wuhan",            lat:30.5928,  lng:114.3052, count:990,  country:"ä¸­å›½",       countryEn:"China"},
  {city:"æ­å·",   cityEn:"Hangzhou",         lat:30.2741,  lng:120.1551, count:1250, country:"ä¸­å›½",       countryEn:"China"},
  {city:"é‡åº†",   cityEn:"Chongqing",        lat:29.5630,  lng:106.5516, count:880,  country:"ä¸­å›½",       countryEn:"China"},
  {city:"ä¸œäº¬",   cityEn:"Tokyo",            lat:35.6762,  lng:139.6503, count:2560, country:"æ—¥æœ¬",       countryEn:"Japan"},
  {city:"å¤§é˜ª",   cityEn:"Osaka",            lat:34.6937,  lng:135.5023, count:1340, country:"æ—¥æœ¬",       countryEn:"Japan"},
  {city:"é¦–å°”",   cityEn:"Seoul",            lat:37.5665,  lng:126.9780, count:1890, country:"éŸ©å›½",       countryEn:"South Korea"},
  {city:"é‡œå±±",   cityEn:"Busan",            lat:35.1796,  lng:129.0756, count:670,  country:"éŸ©å›½",       countryEn:"South Korea"},
  {city:"æ–°åŠ å¡", cityEn:"Singapore",        lat:1.3521,   lng:103.8198, count:1120, country:"æ–°åŠ å¡",     countryEn:"Singapore"},
  {city:"æ›¼è°·",   cityEn:"Bangkok",          lat:13.7563,  lng:100.5018, count:1450, country:"æ³°å›½",       countryEn:"Thailand"},
  {city:"å­Ÿä¹°",   cityEn:"Mumbai",           lat:19.0760,  lng:72.8777,  count:1680, country:"å°åº¦",       countryEn:"India"},
  {city:"å¾·é‡Œ",   cityEn:"Delhi",            lat:28.6139,  lng:77.2090,  count:1230, country:"å°åº¦",       countryEn:"India"},
  {city:"å°åŒ—",   cityEn:"Taipei",           lat:25.0330,  lng:121.5654, count:980,  country:"å°æ¹¾",       countryEn:"Taiwan"},
  {city:"é¦™æ¸¯",   cityEn:"Hong Kong",        lat:22.3193,  lng:114.1694, count:1560, country:"é¦™æ¸¯",       countryEn:"Hong Kong"},
  {city:"å‰éš†å¡", cityEn:"Kuala Lumpur",     lat:3.1390,   lng:101.6869, count:760,  country:"é©¬æ¥è¥¿äºš",   countryEn:"Malaysia"},
  {city:"é›…åŠ è¾¾", cityEn:"Jakarta",          lat:-6.2088,  lng:106.8456, count:890,  country:"å°å°¼",       countryEn:"Indonesia"},
  {city:"å·´é»",      cityEn:"Paris",         lat:48.8566,  lng:2.3522,   count:2340, country:"æ³•å›½",       countryEn:"France"},
  {city:"ä¼¦æ•¦",      cityEn:"London",        lat:51.5074,  lng:-0.1278,  count:2780, country:"è‹±å›½",       countryEn:"UK"},
  {city:"æŸæ—",      cityEn:"Berlin",        lat:52.5200,  lng:13.4050,  count:1450, country:"å¾·å›½",       countryEn:"Germany"},
  {city:"é©¬å¾·é‡Œ",    cityEn:"Madrid",        lat:40.4168,  lng:-3.7038,  count:1230, country:"è¥¿ç­ç‰™",     countryEn:"Spain"},
  {city:"å·´å¡ç½—é‚£",  cityEn:"Barcelona",     lat:41.3851,  lng:2.1734,   count:1080, country:"è¥¿ç­ç‰™",     countryEn:"Spain"},
  {city:"ç½—é©¬",      cityEn:"Rome",          lat:41.9028,  lng:12.4964,  count:1340, country:"æ„å¤§åˆ©",     countryEn:"Italy"},
  {city:"ç±³å…°",      cityEn:"Milan",         lat:45.4642,  lng:9.1900,   count:980,  country:"æ„å¤§åˆ©",     countryEn:"Italy"},
  {city:"é˜¿å§†æ–¯ç‰¹ä¸¹",cityEn:"Amsterdam",    lat:52.3676,  lng:4.9041,   count:890,  country:"è·å…°",       countryEn:"Netherlands"},
  {city:"ç»´ä¹Ÿçº³",    cityEn:"Vienna",        lat:48.2082,  lng:16.3738,  count:670,  country:"å¥¥åœ°åˆ©",     countryEn:"Austria"},
  {city:"è‹é»ä¸–",    cityEn:"Zurich",        lat:47.3769,  lng:8.5417,   count:450,  country:"ç‘å£«",       countryEn:"Switzerland"},
  {city:"è«æ–¯ç§‘",    cityEn:"Moscow",        lat:55.7558,  lng:37.6173,  count:1760, country:"ä¿„ç½—æ–¯",     countryEn:"Russia"},
  {city:"åœ£å½¼å¾—å ¡",  cityEn:"St. Petersburg",lat:59.9311, lng:30.3609,  count:780,  country:"ä¿„ç½—æ–¯",     countryEn:"Russia"},
  {city:"åæ²™",      cityEn:"Warsaw",        lat:52.2297,  lng:21.0122,  count:540,  country:"æ³¢å…°",       countryEn:"Poland"},
  {city:"å¸ƒæ‹‰æ ¼",    cityEn:"Prague",        lat:50.0755,  lng:14.4378,  count:430,  country:"æ·å…‹",       countryEn:"Czech Republic"},
  {city:"çº½çº¦",      cityEn:"New York",      lat:40.7128,  lng:-74.0060, count:3450, country:"ç¾å›½",       countryEn:"USA"},
  {city:"æ´›æ‰çŸ¶",    cityEn:"Los Angeles",   lat:34.0522,  lng:-118.2437,count:2680, country:"ç¾å›½",       countryEn:"USA"},
  {city:"èŠåŠ å“¥",    cityEn:"Chicago",       lat:41.8781,  lng:-87.6298, count:1890, country:"ç¾å›½",       countryEn:"USA"},
  {city:"æ—§é‡‘å±±",    cityEn:"San Francisco", lat:37.7749,  lng:-122.4194,count:1670, country:"ç¾å›½",       countryEn:"USA"},
  {city:"è¿ˆé˜¿å¯†",    cityEn:"Miami",         lat:25.7617,  lng:-80.1918, count:1340, country:"ç¾å›½",       countryEn:"USA"},
  {city:"ä¼‘æ–¯é¡¿",    cityEn:"Houston",       lat:29.7604,  lng:-95.3698, count:980,  country:"ç¾å›½",       countryEn:"USA"},
  {city:"å¤šä¼¦å¤š",    cityEn:"Toronto",       lat:43.6532,  lng:-79.3832, count:1230, country:"åŠ æ‹¿å¤§",     countryEn:"Canada"},
  {city:"æ¸©å“¥å",    cityEn:"Vancouver",     lat:49.2827,  lng:-123.1207,count:890,  country:"åŠ æ‹¿å¤§",     countryEn:"Canada"},
  {city:"åœ£ä¿ç½—",    cityEn:"SÃ£o Paulo",     lat:-23.5505, lng:-46.6333, count:1560, country:"å·´è¥¿",       countryEn:"Brazil"},
  {city:"é‡Œçº¦çƒ­å†…å¢",cityEn:"Rio de Janeiro",lat:-22.9068, lng:-43.1729, count:1340, country:"å·´è¥¿",       countryEn:"Brazil"},
  {city:"å¢¨è¥¿å“¥åŸ",  cityEn:"Mexico City",   lat:19.4326,  lng:-99.1332, count:1120, country:"å¢¨è¥¿å“¥",     countryEn:"Mexico"},
  {city:"å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯",cityEn:"Buenos Aires",lat:-34.6037,lng:-58.3816,count:870, country:"é˜¿æ ¹å»·",     countryEn:"Argentina"},
  {city:"è¿ªæ‹œ",      cityEn:"Dubai",         lat:25.2048,  lng:55.2708,  count:1890, country:"é˜¿è”é…‹",     countryEn:"UAE"},
  {city:"å¼€ç½—",      cityEn:"Cairo",         lat:30.0444,  lng:31.2357,  count:980,  country:"åŸƒåŠ",       countryEn:"Egypt"},
  {city:"æ‹‰å„æ–¯",    cityEn:"Lagos",         lat:6.5244,   lng:3.3792,   count:670,  country:"å°¼æ—¥åˆ©äºš",   countryEn:"Nigeria"},
  {city:"çº¦ç¿°å†…æ–¯å ¡",cityEn:"Johannesburg",  lat:-26.2041, lng:28.0473,  count:560,  country:"å—é",       countryEn:"South Africa"},
  {city:"ä¼Šæ–¯å¦å¸ƒå°”",cityEn:"Istanbul",      lat:41.0082,  lng:28.9784,  count:1450, country:"åœŸè€³å…¶",     countryEn:"Turkey"},
  {city:"æ‚‰å°¼",   cityEn:"Sydney",    lat:-33.8688, lng:151.2093, count:1340, country:"æ¾³å¤§åˆ©äºš", countryEn:"Australia"},
  {city:"å¢¨å°”æœ¬", cityEn:"Melbourne", lat:-37.8136, lng:144.9631, count:980,  country:"æ¾³å¤§åˆ©äºš", countryEn:"Australia"},
  {city:"å¥¥å…‹å…°", cityEn:"Auckland",  lat:-36.8485, lng:174.7633, count:430,  country:"æ–°è¥¿å…°",   countryEn:"New Zealand"},
];

// Pre-built lookups
const CITIES_BY_ZHKEY = {}; // zh country key â†’ city array
CITY_DATA.forEach(d => {
  if (!CITIES_BY_ZHKEY[d.country]) CITIES_BY_ZHKEY[d.country] = [];
  CITIES_BY_ZHKEY[d.country].push(d);
});

// Unique country pairs, ordered by first appearance
const COUNTRY_PAIRS = (() => {
  const seen = new Set(), out = [];
  CITY_DATA.forEach(d => {
    if (!seen.has(d.country)) { seen.add(d.country); out.push({zh:d.country, en:d.countryEn}); }
  });
  return out;
})();

// Coords lookup (both language names)
const COORD_MAP = {};
CITY_DATA.forEach(d => {
  COORD_MAP[d.city]   = {lat:d.lat, lng:d.lng};
  COORD_MAP[d.cityEn] = {lat:d.lat, lng:d.lng};
});

let hotData    = CITY_DATA.map(d => ({...d}));
let totalCount = hotData.reduce((s,d) => s+d.count, 0);
let todayCount = Math.floor(totalCount * 0.03);

// Currently selected country (stored as zh key â€” language-independent)
let selectedZhCountry = '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  3. COUNTRY / CITY SELECT â€” called by applyLang()
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildCountrySelect() {
  const sel  = document.getElementById('country-select');
  const lang = currentLang;  // read AFTER currentLang is set

  // Sort country list for display language
  const sorted = [...COUNTRY_PAIRS].sort((a,b) =>
    lang === 'en' ? a.en.localeCompare(b.en,'en') : a.zh.localeCompare(b.zh,'zh')
  );

  // Rebuild options
  sel.innerHTML = '';
  const ph = document.createElement('option');
  ph.value = ''; ph.textContent = TRANSLATIONS[lang].countryPH;
  sel.appendChild(ph);

  sorted.forEach(pair => {
    const opt = document.createElement('option');
    opt.value = pair.zh;                                      // ALWAYS zh key as value
    opt.textContent = lang === 'en' ? pair.en : pair.zh;     // display in selected lang
    sel.appendChild(opt);
  });

  // Restore previous selection
  if (selectedZhCountry) sel.value = selectedZhCountry;

  // Rebuild city suggestions
  buildCityDatalist();
}

function buildCityDatalist() {
  const dl   = document.getElementById('city-datalist');
  const lang = currentLang;
  dl.innerHTML = '';
  (CITIES_BY_ZHKEY[selectedZhCountry] || []).forEach(c => {
    const opt = document.createElement('option');
    opt.value = lang === 'en' ? c.cityEn : c.city;
    dl.appendChild(opt);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  4. COUNTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function animCount(el, target, dur=2000, pre='') {
  let n=0; const step=target/(dur/16);
  const t=setInterval(()=>{n+=step; if(n>=target){n=target;clearInterval(t);} el.textContent=pre+Math.floor(n).toLocaleString();},16);
}
setTimeout(()=>{
  animCount(document.getElementById('total-count'), totalCount);
  animCount(document.getElementById('today-count'), todayCount, 1500, '+');
},600);
setInterval(()=>{
  const inc=Math.floor(Math.random()*5)+1;
  totalCount+=inc; todayCount+=inc;
  document.getElementById('total-count').textContent=totalCount.toLocaleString();
  document.getElementById('today-count').textContent='+'+todayCount.toLocaleString();
},3000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  5. GLOBE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const globeContainer = document.getElementById('globe-container');
let globe = null;
function riskLevel(n){return n>=2000?'high':n>=1000?'medium':n>=400?'low':'minimal';}
function riskColor(n){return n>=2000?'#ff3d3d':n>=1000?'#ff7c1f':n>=400?'#ffd23f':'rgba(200,210,255,0.5)';}
function ptSize(n){return Math.min(0.3+Math.sqrt(n/100)*0.12,1.8);}
function applyBright(hex,b,a){
  if(hex.startsWith('rgba'))return hex;
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),bl=parseInt(hex.slice(5,7),16);
  return`rgba(${Math.min(255,Math.round(r*b))},${Math.min(255,Math.round(g*b))},${Math.min(255,Math.round(bl*b))},${a.toFixed(2)})`;
}
async function initGlobe(){
  let geo=null;
  try{
    const res=await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
    const topo=await res.json();
    const {feature}=await import('https://cdn.skypack.dev/topojson-client@3');
    geo=feature(topo,topo.objects.countries);
  }catch(e){console.warn('geo fail');}
  globe=Globe({animateIn:true})(globeContainer)
    .backgroundColor('#000510')
    .globeImageUrl('https://unpkg.com/three-globe@2.30.0/example/img/earth-night.jpg')
    .atmosphereColor('#0066ff').atmosphereAltitude(0.25)
    .pointsData(hotData.map(d=>({...d,color:riskColor(d.count),size:ptSize(d.count)})))
    .pointLat('lat').pointLng('lng').pointColor('color').pointRadius('size')
    .pointAltitude(0.005).pointsMerge(false)
    .onPointClick(pt=>{
      const city   =currentLang==='en'?(pt.cityEn||pt.city):pt.city;
      const country=currentLang==='en'?(pt.countryEn||pt.country):pt.country;
      showToast(T('pointToast')(city,country,pt.count.toLocaleString()));
    });
  if(geo){
    globe.polygonsData(geo.features)
      .polygonCapColor(()=>'rgba(0,8,30,0.6)').polygonSideColor(()=>'rgba(0,150,255,0.05)')
      .polygonStrokeColor(()=>'#0096ff').polygonAltitude(0.001);
  }
  const c=globe.controls();
  c.autoRotate=true; c.autoRotateSpeed=0.4; c.enableDamping=true; c.dampingFactor=0.1;
  c.minDistance=150; c.maxDistance=600;
  globe.pointOfView({lat:30,lng:108,altitude:2.2},1000);
  let lb=0;
  (function anim(ts){
    requestAnimationFrame(anim); if(ts-lb<60)return; lb=ts;
    const t=ts*.001;
    globe.pointsData(hotData.map(d=>{
      const risk=riskLevel(d.count),ph=d.lat*.13+d.lng*.07;
      let b,a,sm;
      if(risk==='high'){const r=Math.sin(t*7.5+ph);b=r>.1?1:.05;a=r>.1?1:.08;sm=r>.1?1.4:.6;}
      else if(risk==='medium'){const r=(Math.sin(t*3.2+ph)+1)/2;b=.3+.7*r;a=.25+.75*r;sm=.9+.3*r;}
      else if(risk==='low'){const r=(Math.sin(t*1.4+ph)+1)/2;b=.55+.45*r;a=.45+.45*r;sm=.95+.1*r;}
      else{b=.3+.1*Math.sin(t*.5+ph);a=b;sm=1;}
      return{...d,color:applyBright(riskColor(d.count),b,a),size:ptSize(d.count)*sm};
    }));
  })(0);
}
initGlobe();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  6. RIPPLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rc=document.getElementById('ripple-canvas'),rx=rc.getContext('2d');
let ripples=[];
function rsz(){rc.width=innerWidth;rc.height=innerHeight;}
rsz(); window.addEventListener('resize',rsz);
function mkRipple(x,y){ripples.push({x,y,r:0,maxR:180,alpha:1,t:0});}
(function dr(){
  rx.clearRect(0,0,rc.width,rc.height);
  ripples=ripples.filter(p=>p.alpha>.01);
  ripples.forEach(p=>{
    p.t+=.03; p.r=p.maxR*(1-Math.exp(-p.t*2)); p.alpha=Math.exp(-p.t*1.2);
    rx.beginPath();rx.arc(p.x,p.y,p.r,0,Math.PI*2);rx.strokeStyle=`rgba(255,80,30,${p.alpha*.9})`;rx.lineWidth=3;rx.stroke();
    if(p.r>30){rx.beginPath();rx.arc(p.x,p.y,p.r*.6,0,Math.PI*2);rx.strokeStyle=`rgba(255,160,60,${p.alpha*.6})`;rx.lineWidth=1.5;rx.stroke();}
    const g=rx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*.3);
    g.addColorStop(0,`rgba(255,120,40,${p.alpha*.4})`);g.addColorStop(1,'transparent');
    rx.beginPath();rx.arc(p.x,p.y,p.r*.3,0,Math.PI*2);rx.fillStyle=g;rx.fill();
  });
  requestAnimationFrame(dr);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  7. TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg,dur=3200){
  const el=document.getElementById('toast');
  el.textContent=msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),dur);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  8. MODAL EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const overlay=document.getElementById('modal-overlay');
const countryEl=document.getElementById('country-select');
const cityEl=document.getElementById('city-input');

document.querySelectorAll('.radio-btn,.chip').forEach(el=>{
  el.addEventListener('click',()=>{
    document.querySelectorAll(`[data-group="${el.dataset.group}"]`).forEach(e=>e.classList.remove('selected'));
    el.classList.add('selected');
  });
});

countryEl.addEventListener('change',()=>{
  selectedZhCountry=countryEl.value;   // always zh key
  cityEl.value='';
  buildCityDatalist();
});

document.getElementById('fab').addEventListener('click',()=>overlay.classList.add('open'));
document.getElementById('modal-cancel').addEventListener('click',()=>overlay.classList.remove('open'));
overlay.addEventListener('click',e=>{if(e.target===overlay)overlay.classList.remove('open');});

document.getElementById('modal-submit').addEventListener('click',()=>{
  const gender=document.querySelector('[data-group="gender"].selected')?.dataset.val;
  const type  =document.querySelector('[data-group="type"].selected')?.dataset.val;
  const zhCnt =countryEl.value;
  const city  =cityEl.value.trim();
  if(!gender||!type||!zhCnt||!city){showToast(T('toastWarn'),2500);return;}
  overlay.classList.remove('open');
  let existing=hotData.find(d=>d.city===city||d.cityEn===city);
  let lat,lng;
  if(existing){existing.count+=Math.floor(Math.random()*50)+10;lat=existing.lat;lng=existing.lng;}
  else{
    const co=COORD_MAP[city],fb=(CITIES_BY_ZHKEY[zhCnt]||[])[0];
    lat=co?.lat??fb?.lat??(30+(Math.random()-.5)*40);
    lng=co?.lng??fb?.lng??(100+(Math.random()-.5)*80);
    hotData.push({city,cityEn:city,country:zhCnt,countryEn:zhCnt,lat,lng,count:80});
    totalCount+=80;todayCount+=80;
  }
  if(globe){
    globe.controls().autoRotate=false;
    globe.pointOfView({lat,lng,altitude:1.2},2000);
    setTimeout(()=>{
      const pos=globe.getScreenCoords(lat,lng,.01);
      if(pos){for(let i=0;i<4;i++)setTimeout(()=>mkRipple(pos.x,pos.y),i*300);}
      showToast(T('toastSuccess'));
      setTimeout(()=>{if(globe)globe.controls().autoRotate=true;},4000);
    },2200);
  }
  document.getElementById('total-count').textContent=totalCount.toLocaleString();
  document.getElementById('today-count').textContent='+'+todayCount.toLocaleString();
});

window.addEventListener('resize',()=>{if(globe){globe.width(innerWidth);globe.height(innerHeight);}});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  9. INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildCountrySelect();  // initial zh render
</script>
</body>
</html>
