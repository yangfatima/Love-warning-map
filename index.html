<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ’” å…¨çƒæ‹çˆ±é¿é›·åœ°å›¾</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/globe.gl@2.27.2/dist/globe.gl.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Orbitron:wght@400;700;900&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #000510;
    --glass: rgba(255,255,255,0.04);
    --glass-border: rgba(0,150,255,0.2);
    --blue: #0096ff;
    --blue-dim: rgba(0,150,255,0.15);
    --red: #ff3d3d;
    --orange: #ff7c1f;
    --yellow: #ffd23f;
    --white-dim: rgba(255,255,255,0.4);
  }

  html, body {
    width: 100%; height: 100%;
    background: var(--bg);
    overflow: hidden;
    font-family: 'Noto Sans SC', sans-serif;
    color: #fff;
  }

  #globe-container {
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
  }

  /* â”€â”€ DASHBOARD (top-left) â”€â”€ */
  #dashboard {
    position: fixed; top: 20px; left: 20px;
    background: var(--glass);
    backdrop-filter: blur(20px) saturate(160%);
    -webkit-backdrop-filter: blur(20px) saturate(160%);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 18px 24px;
    min-width: 220px;
    box-shadow: 0 8px 32px rgba(0,150,255,0.1), inset 0 1px 0 rgba(255,255,255,0.06);
    z-index: 10;
  }
  #dashboard .label {
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
    color: var(--blue); opacity: 0.7; margin-bottom: 4px;
  }
  #dashboard .value {
    font-family: 'Orbitron', monospace;
    font-size: 28px; font-weight: 700;
    background: linear-gradient(135deg, #fff 40%, var(--blue));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    line-height: 1.1;
  }
  #dashboard .sub-value {
    font-family: 'Orbitron', monospace;
    font-size: 18px; font-weight: 400; color: var(--orange);
    margin-top: 6px;
  }
  #dashboard .divider { height: 1px; background: var(--glass-border); margin: 12px 0; }
  #dashboard .today-label { font-size: 10px; letter-spacing: 2px; color: var(--orange); opacity: 0.7; margin-bottom: 2px; }

  /* â”€â”€ LEGEND (top-right) â”€â”€ */
  #legend {
    position: fixed; top: 20px; right: 20px;
    background: var(--glass);
    backdrop-filter: blur(20px) saturate(160%);
    -webkit-backdrop-filter: blur(20px) saturate(160%);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 16px 20px;
    z-index: 10;
    box-shadow: 0 8px 32px rgba(0,150,255,0.1), inset 0 1px 0 rgba(255,255,255,0.06);
  }
  #legend h3 { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--blue); margin-bottom: 12px; }
  .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; color: rgba(255,255,255,0.8); }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .dot-red { background: var(--red); box-shadow: 0 0 8px var(--red); animation: pulse-red 0.8s ease-in-out infinite; }
  .dot-orange { background: var(--orange); box-shadow: 0 0 6px var(--orange); animation: pulse-red 1.4s ease-in-out infinite; }
  .dot-yellow { background: var(--yellow); box-shadow: 0 0 4px var(--yellow); animation: pulse-red 2.5s ease-in-out infinite; }
  .dot-white { background: rgba(255,255,255,0.4); }
  @keyframes pulse-red { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.7)} }

  /* â”€â”€ FAB BUTTON (bottom-right) â”€â”€ */
  #fab {
    position: fixed; bottom: 30px; right: 24px;
    background: linear-gradient(135deg, #ff4e6a, #ff7c1f);
    border: none; border-radius: 50px;
    padding: 14px 22px;
    color: #fff; font-size: 13px; font-weight: 500;
    font-family: 'Noto Sans SC', sans-serif;
    cursor: pointer; z-index: 10;
    box-shadow: 0 4px 24px rgba(255,78,106,0.5);
    transition: transform 0.2s, box-shadow 0.2s;
    white-space: nowrap;
    letter-spacing: 0.5px;
  }
  #fab:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 32px rgba(255,78,106,0.7); }
  #fab:active { transform: scale(0.97); }

  /* â”€â”€ MODAL OVERLAY â”€â”€ */
  #modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,5,16,0.75);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 100;
    display: none; align-items: center; justify-content: center;
    padding: 16px;
  }
  #modal-overlay.open { display: flex; }

  #modal {
    background: #fff;
    border-radius: 20px;
    padding: 32px;
    width: 100%; max-width: 440px;
    color: #111;
    box-shadow: 0 24px 80px rgba(0,0,0,0.6);
    animation: modal-in 0.3s cubic-bezier(0.34,1.56,0.64,1);
    max-height: 90vh; overflow-y: auto;
  }
  @keyframes modal-in { from { opacity:0; transform:scale(0.85) translateY(20px); } to { opacity:1; transform:none; } }

  #modal h2 { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
  #modal .modal-sub { font-size: 13px; color: #666; margin-bottom: 24px; }

  .form-group { margin-bottom: 18px; }
  .form-group label { display: block; font-size: 12px; font-weight: 500; color: #444; margin-bottom: 8px; letter-spacing: 0.5px; }

  .radio-group { display: flex; gap: 10px; flex-wrap: wrap; }
  .radio-btn { flex: 1; min-width: 80px; background: #f4f4f6; border: 2px solid transparent; border-radius: 10px; padding: 10px; text-align: center; font-size: 13px; cursor: pointer; transition: all 0.15s; user-select: none; }
  .radio-btn:hover { border-color: #ddd; }
  .radio-btn.selected { background: #fff0f3; border-color: #ff4e6a; color: #ff4e6a; font-weight: 600; }

  .chip-group { display: flex; gap: 8px; flex-wrap: wrap; }
  .chip { background: #f4f4f6; border: 2px solid transparent; border-radius: 20px; padding: 7px 14px; font-size: 12px; cursor: pointer; transition: all 0.15s; user-select: none; white-space: nowrap; }
  .chip:hover { border-color: #ddd; }
  .chip.selected { background: #fff3e8; border-color: var(--orange); color: var(--orange); font-weight: 600; }

  select, input[type="text"] {
    width: 100%; padding: 11px 14px; border: 2px solid #eee; border-radius: 10px;
    font-size: 14px; font-family: inherit; outline: none; transition: border-color 0.15s;
    background: #fafafa; color: #111;
  }
  select:focus, input[type="text"]:focus { border-color: #0096ff; background: #fff; }

  .modal-footer { display: flex; gap: 12px; margin-top: 24px; }
  .btn-cancel { flex: 1; padding: 13px; border: 2px solid #eee; background: transparent; border-radius: 10px; font-size: 14px; cursor: pointer; font-family: inherit; transition: all 0.15s; }
  .btn-cancel:hover { border-color: #ccc; }
  .btn-submit { flex: 2; padding: 13px; background: linear-gradient(135deg, #ff4e6a, #ff7c1f); border: none; border-radius: 10px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s; }
  .btn-submit:hover { opacity: 0.9; transform: translateY(-1px); }

  /* â”€â”€ TOAST â”€â”€ */
  #toast {
    position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: rgba(30,30,40,0.95); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px; padding: 12px 24px; font-size: 13px; color: #fff;
    z-index: 200; opacity: 0; transition: all 0.4s; pointer-events: none; white-space: nowrap;
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* â”€â”€ RIPPLE CANVAS â”€â”€ */
  #ripple-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 5; }

  /* mobile */
  @media (max-width: 480px) {
    #dashboard { top: 10px; left: 10px; padding: 12px 16px; min-width: 160px; }
    #dashboard .value { font-size: 20px; }
    #legend { top: 10px; right: 10px; padding: 12px 14px; }
    #fab { bottom: 20px; right: 12px; font-size: 12px; padding: 12px 16px; }
    #modal { padding: 24px 20px; }
  }
</style>
</head>
<body>

<div id="globe-container"></div>
<canvas id="ripple-canvas"></canvas>

<!-- Dashboard -->
<div id="dashboard">
  <div class="label">ğŸ’” å…¨çƒé¿é›·æŠ•ç¥¨æ€»æ•°</div>
  <div class="value" id="total-count">0</div>
  <div class="divider"></div>
  <div class="today-label">ğŸ”¥ ä»Šæ—¥æ–°å¢é¿é›·</div>
  <div class="sub-value" id="today-count">+0</div>
</div>

<!-- Legend -->
<div id="legend">
  <h3>âš¡ é£é™©é¢„è­¦æ ‡å‡†</h3>
  <div class="legend-item"><div class="legend-dot dot-red"></div><span>ğŸ”´ é«˜å±åŒºåŸŸ (å¼ºé—ªçƒ)</span></div>
  <div class="legend-item"><div class="legend-dot dot-orange"></div><span>ğŸŸ  ä¸­åº¦é¢„è­¦ (ä¸­åº¦é—ªçƒ)</span></div>
  <div class="legend-item"><div class="legend-dot dot-yellow"></div><span>ğŸŸ¡ è½»åº¦é£é™© (å¾®å¼±é—ªçƒ)</span></div>
  <div class="legend-item"><div class="legend-dot dot-white"></div><span>âšª æ•°æ®ç¨€å°‘ (é™æ­¢å¾®å…‰)</span></div>
</div>

<!-- FAB -->
<button id="fab">âœ¨ åˆ†äº«ä½ çš„æ‹çˆ±é¿é›·åæ ‡</button>

<!-- Modal -->
<div id="modal-overlay">
  <div id="modal">
    <h2>ğŸ“ æäº¤é¿é›·åæ ‡</h2>
    <p class="modal-sub">ä½ çš„ç»å†å°†å¸®åŠ©å…¨çƒæ‹çˆ±äººå£«é¿å¼€é›·åŒº</p>

    <div class="form-group">
      <label>ä½ çš„æ€§åˆ«</label>
      <div class="radio-group">
        <div class="radio-btn" data-group="gender" data-val="male">â™‚ ç”·</div>
        <div class="radio-btn" data-group="gender" data-val="female">â™€ å¥³</div>
      </div>
    </div>

    <div class="form-group">
      <label>è¸©é›·ç±»å‹</label>
      <div class="chip-group">
        <div class="chip" data-group="type" data-val="ghost">ğŸ‘» å¤±è”</div>
        <div class="chip" data-group="type" data-val="multiline">ğŸ­ æš§æ˜§å¤šçº¿</div>
        <div class="chip" data-group="type" data-val="pie">ğŸ¥§ ç”»é¥¼</div>
        <div class="chip" data-group="type" data-val="ignore">ğŸ“µ å·²è¯»ä¸å›</div>
        <div class="chip" data-group="type" data-val="other">ğŸ’« å…¶å®ƒ</div>
      </div>
    </div>

    <div class="form-group">
      <label>å‘ç”Ÿåœ°ç‚¹ â€” å›½å®¶</label>
      <select id="country-select">
        <option value="">è¯·é€‰æ‹©å›½å®¶...</option>
      </select>
    </div>

    <div class="form-group">
      <label>å‘ç”Ÿåœ°ç‚¹ â€” åŸå¸‚</label>
      <input type="text" id="city-input" placeholder="è¾“å…¥åŸå¸‚åç§°ï¼Œå¦‚ ä¸Šæµ·ã€Tokyo..." list="city-suggestions">
      <datalist id="city-suggestions"></datalist>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" id="modal-cancel">å–æ¶ˆ</button>
      <button class="btn-submit" id="modal-submit">ğŸš¨ æäº¤é¿é›·ï¼</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast">âœ… é¿é›·åæ ‡å·²æ ‡è®°ï¼æ„Ÿè°¢ä½ çš„è´¡çŒ®</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INITIAL DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const INITIAL_DATA = [
  // Asia - high density
  { city: "ä¸Šæµ·", lat: 31.2304, lng: 121.4737, count: 3240, country: "ä¸­å›½" },
  { city: "åŒ—äº¬", lat: 39.9042, lng: 116.4074, count: 2980, country: "ä¸­å›½" },
  { city: "å¹¿å·", lat: 23.1291, lng: 113.2644, count: 2100, country: "ä¸­å›½" },
  { city: "æ·±åœ³", lat: 22.5431, lng: 114.0579, count: 1870, country: "ä¸­å›½" },
  { city: "æˆéƒ½", lat: 30.5728, lng: 104.0668, count: 1430, country: "ä¸­å›½" },
  { city: "æ­¦æ±‰", lat: 30.5928, lng: 114.3052, count: 990, country: "ä¸­å›½" },
  { city: "æ­å·", lat: 30.2741, lng: 120.1551, count: 1250, country: "ä¸­å›½" },
  { city: "é‡åº†", lat: 29.5630, lng: 106.5516, count: 880, country: "ä¸­å›½" },
  { city: "ä¸œäº¬", lat: 35.6762, lng: 139.6503, count: 2560, country: "æ—¥æœ¬" },
  { city: "å¤§é˜ª", lat: 34.6937, lng: 135.5023, count: 1340, country: "æ—¥æœ¬" },
  { city: "é¦–å°”", lat: 37.5665, lng: 126.9780, count: 1890, country: "éŸ©å›½" },
  { city: "é‡œå±±", lat: 35.1796, lng: 129.0756, count: 670, country: "éŸ©å›½" },
  { city: "æ–°åŠ å¡", lat: 1.3521, lng: 103.8198, count: 1120, country: "æ–°åŠ å¡" },
  { city: "æ›¼è°·", lat: 13.7563, lng: 100.5018, count: 1450, country: "æ³°å›½" },
  { city: "å­Ÿä¹°", lat: 19.0760, lng: 72.8777, count: 1680, country: "å°åº¦" },
  { city: "å¾·é‡Œ", lat: 28.6139, lng: 77.2090, count: 1230, country: "å°åº¦" },
  { city: "å°åŒ—", lat: 25.0330, lng: 121.5654, count: 980, country: "å°æ¹¾" },
  { city: "é¦™æ¸¯", lat: 22.3193, lng: 114.1694, count: 1560, country: "é¦™æ¸¯" },
  { city: "å‰éš†å¡", lat: 3.1390, lng: 101.6869, count: 760, country: "é©¬æ¥è¥¿äºš" },
  { city: "é›…åŠ è¾¾", lat: -6.2088, lng: 106.8456, count: 890, country: "å°å°¼" },
  // Europe
  { city: "å·´é»", lat: 48.8566, lng: 2.3522, count: 2340, country: "æ³•å›½" },
  { city: "ä¼¦æ•¦", lat: 51.5074, lng: -0.1278, count: 2780, country: "è‹±å›½" },
  { city: "æŸæ—", lat: 52.5200, lng: 13.4050, count: 1450, country: "å¾·å›½" },
  { city: "é©¬å¾·é‡Œ", lat: 40.4168, lng: -3.7038, count: 1230, country: "è¥¿ç­ç‰™" },
  { city: "å·´å¡ç½—é‚£", lat: 41.3851, lng: 2.1734, count: 1080, country: "è¥¿ç­ç‰™" },
  { city: "ç½—é©¬", lat: 41.9028, lng: 12.4964, count: 1340, country: "æ„å¤§åˆ©" },
  { city: "ç±³å…°", lat: 45.4642, lng: 9.1900, count: 980, country: "æ„å¤§åˆ©" },
  { city: "é˜¿å§†æ–¯ç‰¹ä¸¹", lat: 52.3676, lng: 4.9041, count: 890, country: "è·å…°" },
  { city: "ç»´ä¹Ÿçº³", lat: 48.2082, lng: 16.3738, count: 670, country: "å¥¥åœ°åˆ©" },
  { city: "è‹é»ä¸–", lat: 47.3769, lng: 8.5417, count: 450, country: "ç‘å£«" },
  { city: "è«æ–¯ç§‘", lat: 55.7558, lng: 37.6173, count: 1760, country: "ä¿„ç½—æ–¯" },
  { city: "åœ£å½¼å¾—å ¡", lat: 59.9311, lng: 30.3609, count: 780, country: "ä¿„ç½—æ–¯" },
  { city: "åæ²™", lat: 52.2297, lng: 21.0122, count: 540, country: "æ³¢å…°" },
  { city: "å¸ƒæ‹‰æ ¼", lat: 50.0755, lng: 14.4378, count: 430, country: "æ·å…‹" },
  // Americas
  { city: "çº½çº¦", lat: 40.7128, lng: -74.0060, count: 3450, country: "ç¾å›½" },
  { city: "æ´›æ‰çŸ¶", lat: 34.0522, lng: -118.2437, count: 2680, country: "ç¾å›½" },
  { city: "èŠåŠ å“¥", lat: 41.8781, lng: -87.6298, count: 1890, country: "ç¾å›½" },
  { city: "æ—§é‡‘å±±", lat: 37.7749, lng: -122.4194, count: 1670, country: "ç¾å›½" },
  { city: "è¿ˆé˜¿å¯†", lat: 25.7617, lng: -80.1918, count: 1340, country: "ç¾å›½" },
  { city: "ä¼‘æ–¯é¡¿", lat: 29.7604, lng: -95.3698, count: 980, country: "ç¾å›½" },
  { city: "å¤šä¼¦å¤š", lat: 43.6532, lng: -79.3832, count: 1230, country: "åŠ æ‹¿å¤§" },
  { city: "æ¸©å“¥å", lat: 49.2827, lng: -123.1207, count: 890, country: "åŠ æ‹¿å¤§" },
  { city: "åœ£ä¿ç½—", lat: -23.5505, lng: -46.6333, count: 1560, country: "å·´è¥¿" },
  { city: "é‡Œçº¦çƒ­å†…å¢", lat: -22.9068, lng: -43.1729, count: 1340, country: "å·´è¥¿" },
  { city: "å¢¨è¥¿å“¥åŸ", lat: 19.4326, lng: -99.1332, count: 1120, country: "å¢¨è¥¿å“¥" },
  { city: "å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯", lat: -34.6037, lng: -58.3816, count: 870, country: "é˜¿æ ¹å»·" },
  // Middle East & Africa
  { city: "è¿ªæ‹œ", lat: 25.2048, lng: 55.2708, count: 1890, country: "é˜¿è”é…‹" },
  { city: "å¼€ç½—", lat: 30.0444, lng: 31.2357, count: 980, country: "åŸƒåŠ" },
  { city: "æ‹‰å„æ–¯", lat: 6.5244, lng: 3.3792, count: 670, country: "å°¼æ—¥åˆ©äºš" },
  { city: "çº¦ç¿°å†…æ–¯å ¡", lat: -26.2041, lng: 28.0473, count: 560, country: "å—é" },
  { city: "ä¼Šæ–¯å¦å¸ƒå°”", lat: 41.0082, lng: 28.9784, count: 1450, country: "åœŸè€³å…¶" },
  // Oceania
  { city: "æ‚‰å°¼", lat: -33.8688, lng: 151.2093, count: 1340, country: "æ¾³å¤§åˆ©äºš" },
  { city: "å¢¨å°”æœ¬", lat: -37.8136, lng: 144.9631, count: 980, country: "æ¾³å¤§åˆ©äºš" },
  { city: "å¥¥å…‹å…°", lat: -36.8485, lng: 174.7633, count: 430, country: "æ–°è¥¿å…°" },
];

const COUNTRIES = [...new Set(INITIAL_DATA.map(d => d.country))].sort();
const CITIES_BY_COUNTRY = {};
INITIAL_DATA.forEach(d => {
  if (!CITIES_BY_COUNTRY[d.country]) CITIES_BY_COUNTRY[d.country] = [];
  CITIES_BY_COUNTRY[d.country].push(d);
});

// City name -> lat/lng lookup
const CITY_COORDS = {};
INITIAL_DATA.forEach(d => { CITY_COORDS[d.city] = { lat: d.lat, lng: d.lng }; });

let totalCount = INITIAL_DATA.reduce((s, d) => s + d.count, 0);
let todayCount = Math.floor(totalCount * 0.03);
let hotData = INITIAL_DATA.map(d => ({ ...d }));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD COUNTER ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function animateCounter(el, target, duration = 2000, prefix = '') {
  let start = 0;
  const step = target / (duration / 16);
  const timer = setInterval(() => {
    start += step;
    if (start >= target) { start = target; clearInterval(timer); }
    el.textContent = prefix + Math.floor(start).toLocaleString('zh-CN');
  }, 16);
}

setTimeout(() => {
  animateCounter(document.getElementById('total-count'), totalCount);
  animateCounter(document.getElementById('today-count'), todayCount, 1500, '+');
}, 600);

// Live ticker simulation
setInterval(() => {
  const inc = Math.floor(Math.random() * 5) + 1;
  totalCount += inc;
  todayCount += inc;
  document.getElementById('total-count').textContent = totalCount.toLocaleString('zh-CN');
  document.getElementById('today-count').textContent = '+' + todayCount.toLocaleString('zh-CN');
}, 3000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBE SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const container = document.getElementById('globe-container');

const Globe = window.Globe;
let globe = null;
let time = 0;
let autoRotate = true;

function getRiskLevel(count) {
  if (count >= 2000) return 'high';
  if (count >= 1000) return 'medium';
  if (count >= 400) return 'low';
  return 'minimal';
}

function getRiskColor(count) {
  if (count >= 2000) return '#ff3d3d';
  if (count >= 1000) return '#ff7c1f';
  if (count >= 400) return '#ffd23f';
  return 'rgba(200,210,255,0.5)';
}

function getPointSize(count) {
  const base = 0.3;
  const scale = Math.sqrt(count / 100) * 0.12;
  return Math.min(base + scale, 1.8);
}

// Build points array for THREE particle system approach via custom layer
function buildPointsData() {
  return hotData.map(d => ({
    ...d,
    color: getRiskColor(d.count),
    size: getPointSize(d.count),
    risk: getRiskLevel(d.count)
  }));
}

async function initGlobe() {
  // Load countries geojson
  let geoJson = null;
  try {
    const res = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
    const topo = await res.json();
    const { feature } = await import('https://cdn.skypack.dev/topojson-client@3');
    geoJson = feature(topo, topo.objects.countries);
  } catch(e) {
    console.warn('GeoJSON load failed, using fallback');
  }

  globe = Globe({ animateIn: true })(container)
    .backgroundColor('#000510')
    .globeImageUrl('https://unpkg.com/three-globe@2.30.0/example/img/earth-night.jpg')
    .atmosphereColor('#0066ff')
    .atmosphereAltitude(0.25)
    .pointsData(buildPointsData())
    .pointLat('lat')
    .pointLng('lng')
    .pointColor('color')
    .pointRadius('size')
    .pointAltitude(0.005)
    .pointsMerge(false)
    .onPointClick((point) => {
      showToast(`ğŸ“ ${point.city} Â· ${point.country} â€” ${point.count.toLocaleString()} æ¬¡é¿é›·è®°å½•`);
    });

  if (geoJson) {
    globe
      .polygonsData(geoJson.features)
      .polygonCapColor(() => 'rgba(0,8,30,0.6)')
      .polygonSideColor(() => 'rgba(0,150,255,0.05)')
      .polygonStrokeColor(() => '#0096ff')
      .polygonAltitude(0.001);
  }

  // Controls
  globe.controls().autoRotate = true;
  globe.controls().autoRotateSpeed = 0.4;
  globe.controls().enableDamping = true;
  globe.controls().dampingFactor = 0.1;
  globe.controls().minDistance = 150;
  globe.controls().maxDistance = 600;

  // Initial POV
  globe.pointOfView({ lat: 30, lng: 108, altitude: 2.2 }, 1000);

  // Blinking animation via requestAnimationFrame
  let lastBlink = 0;
  const blinkIntervals = { high: 800, medium: 1400, low: 2500, minimal: 0 };

  function animate(ts) {
    requestAnimationFrame(animate);
    time = ts * 0.001;

    // Update point colors for blinking effect
    if (ts - lastBlink > 80) {
      lastBlink = ts;
      const updated = hotData.map(d => {
        const risk = getRiskLevel(d.count);
        let brightness = 1;
        if (risk === 'high') {
          brightness = 0.4 + 0.6 * Math.abs(Math.sin(time * 3.8 + d.lat));
        } else if (risk === 'medium') {
          brightness = 0.55 + 0.45 * Math.abs(Math.sin(time * 2.2 + d.lng * 0.05));
        } else if (risk === 'low') {
          brightness = 0.7 + 0.3 * Math.abs(Math.sin(time * 1.1 + d.lat * 0.07));
        } else {
          brightness = 0.35 + 0.15 * Math.abs(Math.sin(time * 0.5));
        }

        const baseColor = getRiskColor(d.count);
        const alpha = 0.3 + 0.7 * brightness;
        return {
          ...d,
          color: applyBrightness(baseColor, brightness, alpha),
          size: getPointSize(d.count) * (0.85 + 0.15 * brightness),
          risk
        };
      });
      globe.pointsData(updated);
    }
  }
  requestAnimationFrame(animate);
}

function applyBrightness(hex, b, alpha) {
  // Parse color and apply brightness
  if (hex.startsWith('rgba')) return hex;
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const bl = parseInt(hex.slice(5,7),16);
  return `rgba(${Math.min(255,Math.round(r*b))},${Math.min(255,Math.round(g*b))},${Math.min(255,Math.round(bl*b))},${alpha.toFixed(2)})`;
}

initGlobe();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RIPPLE CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rCanvas = document.getElementById('ripple-canvas');
const rCtx = rCanvas.getContext('2d');
let ripples = [];

function resizeCanvas() {
  rCanvas.width = window.innerWidth;
  rCanvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function createRipple(screenX, screenY) {
  ripples.push({ x: screenX, y: screenY, r: 0, maxR: 180, alpha: 1, t: 0 });
}

function drawRipples() {
  rCtx.clearRect(0, 0, rCanvas.width, rCanvas.height);
  ripples = ripples.filter(rp => rp.alpha > 0.01);
  ripples.forEach(rp => {
    rp.t += 0.03;
    rp.r = rp.maxR * (1 - Math.exp(-rp.t * 2));
    rp.alpha = Math.exp(-rp.t * 1.2);

    // Outer ring
    rCtx.beginPath();
    rCtx.arc(rp.x, rp.y, rp.r, 0, Math.PI * 2);
    rCtx.strokeStyle = `rgba(255,80,30,${rp.alpha * 0.9})`;
    rCtx.lineWidth = 3;
    rCtx.stroke();

    // Inner ring
    if (rp.r > 30) {
      rCtx.beginPath();
      rCtx.arc(rp.x, rp.y, rp.r * 0.6, 0, Math.PI * 2);
      rCtx.strokeStyle = `rgba(255,160,60,${rp.alpha * 0.6})`;
      rCtx.lineWidth = 1.5;
      rCtx.stroke();
    }

    // Core glow
    const grad = rCtx.createRadialGradient(rp.x, rp.y, 0, rp.x, rp.y, rp.r * 0.3);
    grad.addColorStop(0, `rgba(255,120,40,${rp.alpha * 0.4})`);
    grad.addColorStop(1, 'transparent');
    rCtx.beginPath();
    rCtx.arc(rp.x, rp.y, rp.r * 0.3, 0, Math.PI * 2);
    rCtx.fillStyle = grad;
    rCtx.fill();
  });
  requestAnimationFrame(drawRipples);
}
drawRipples();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL + FORM LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const overlay = document.getElementById('modal-overlay');
const countrySelect = document.getElementById('country-select');
const cityInput = document.getElementById('city-input');
const citySuggestions = document.getElementById('city-suggestions');

// Populate country select
COUNTRIES.forEach(c => {
  const opt = document.createElement('option');
  opt.value = c; opt.textContent = c;
  countrySelect.appendChild(opt);
});

countrySelect.addEventListener('change', () => {
  const cities = CITIES_BY_COUNTRY[countrySelect.value] || [];
  citySuggestions.innerHTML = '';
  cities.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.city;
    citySuggestions.appendChild(opt);
  });
  if (cities.length > 0) cityInput.value = '';
});

// Radio / chip selection
document.querySelectorAll('.radio-btn, .chip').forEach(el => {
  el.addEventListener('click', () => {
    const group = el.dataset.group;
    document.querySelectorAll(`[data-group="${group}"]`).forEach(e => e.classList.remove('selected'));
    el.classList.add('selected');
  });
});

document.getElementById('fab').addEventListener('click', () => {
  overlay.classList.add('open');
});
document.getElementById('modal-cancel').addEventListener('click', () => {
  overlay.classList.remove('open');
});
overlay.addEventListener('click', (e) => {
  if (e.target === overlay) overlay.classList.remove('open');
});

document.getElementById('modal-submit').addEventListener('click', () => {
  const gender = document.querySelector('[data-group="gender"].selected')?.dataset.val;
  const type = document.querySelector('[data-group="type"].selected')?.dataset.val;
  const country = countrySelect.value;
  const city = cityInput.value.trim();

  if (!gender || !type || !country || !city) {
    showToast('âš ï¸ è¯·å¡«å†™æ‰€æœ‰å­—æ®µå†æäº¤', 2500);
    return;
  }

  overlay.classList.remove('open');

  // Find or create data point
  let existing = hotData.find(d => d.city === city);
  let targetLat, targetLng;

  if (existing) {
    existing.count += Math.floor(Math.random() * 50) + 10;
    targetLat = existing.lat;
    targetLng = existing.lng;
  } else {
    // Attempt to find city coords, fallback to country centroid
    const knownCity = CITY_COORDS[city];
    const countryCity = (CITIES_BY_COUNTRY[country] || [])[0];
    targetLat = knownCity?.lat || countryCity?.lat || 30 + (Math.random()-0.5)*40;
    targetLng = knownCity?.lng || countryCity?.lng || 100 + (Math.random()-0.5)*80;

    hotData.push({ city, country, lat: targetLat, lng: targetLng, count: 80 });
    totalCount += 80;
    todayCount += 80;
  }

  // Fly globe to location
  if (globe) {
    globe.controls().autoRotate = false;
    globe.pointOfView({ lat: targetLat, lng: targetLng, altitude: 1.2 }, 2000);

    // Show ripple on screen after arrival
    setTimeout(() => {
      const screenPos = globe.getScreenCoords(targetLat, targetLng, 0.01);
      if (screenPos) {
        for (let i = 0; i < 4; i++) {
          setTimeout(() => createRipple(screenPos.x, screenPos.y), i * 300);
        }
      }
      showToast('ğŸš¨ é¿é›·åæ ‡å·²æ°¸ä¹…æ ‡è®°ï¼ä¿æŠ¤åæ¥è€…');
      // Re-enable rotation after 3s
      setTimeout(() => {
        if (globe) globe.controls().autoRotate = true;
      }, 4000);
    }, 2200);
  }

  totalCount += Math.floor(Math.random() * 10) + 1;
  document.getElementById('total-count').textContent = totalCount.toLocaleString('zh-CN');
  document.getElementById('today-count').textContent = '+' + todayCount.toLocaleString('zh-CN');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, duration = 3000) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), duration);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESPONSIVE RESIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('resize', () => {
  if (globe) {
    globe.width(window.innerWidth);
    globe.height(window.innerHeight);
  }
});
</script>
</body>
</html>
